{% extends "base.html" %}

{% block title %}Voting Results{% endblock %}

{% block head %}
<!-- Google Maps API -->
<script src="https://maps.googleapis.com/maps/api/js?key={{ config.GOOGLE_MAPS_API_KEY }}&libraries=places" defer></script>
<script src="{{ url_for('static', filename='js/maps.js') }}" defer></script>
<!-- Results JS -->
<script src="{{ url_for('static', filename='js/results.js') }}" defer></script>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('group', group_id=group_id) }}" id="group-link">Group</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('venues', group_id=group_id) }}">Venues</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('swipe', group_id=group_id) }}">Vote</a></li>
                <li class="breadcrumb-item active" aria-current="page">Results</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-8">
        <h1>Voting Results</h1>
        <p class="text-muted">See which venues are most popular in your group</p>
    </div>
    <div class="col-md-4 text-md-end">
        <a href="{{ url_for('swipe', group_id=group_id) }}" class="btn btn-primary">
            <i class="fas fa-vote-yea me-2"></i>Continue Voting
        </a>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- Results Container -->
        <div id="results-container">
            <!-- Content will be dynamically populated by results.js -->
        </div>
    </div>
    
    <div class="col-lg-4">
        <!-- Group Info -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white">
                <h5 class="mb-0">Group Info</h5>
            </div>
            <div class="card-body">
                <h5 id="group-name">Loading...</h5>
                <p class="text-muted" id="group-description"></p>
                <div class="d-flex align-items-center mb-3">
                    <div class="me-3">
                        <i class="fas fa-users text-primary me-1"></i>
                        <span id="member-count">0</span> members
                    </div>
                    <div>
                        <i class="fas fa-map-marker-alt text-danger me-1"></i>
                        <span id="location-count">0</span> locations
                    </div>
                </div>
                <div class="d-grid">
                    <a href="{{ url_for('group', group_id=group_id) }}" class="btn btn-outline-primary">
                        <i class="fas fa-users me-2"></i>Group Details
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Share Results -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white">
                <h5 class="mb-0">Share Results</h5>
            </div>
            <div class="card-body">
                <p>Share these results with your group members:</p>
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="share-url" readonly
                           value="{{ request.url_root }}results/{{ group_id }}">
                    <button class="btn btn-outline-primary" type="button" id="copy-url-btn">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
                <div class="d-flex justify-content-center">
                    <button class="btn btn-sm btn-outline-primary me-2" id="share-whatsapp-btn">
                        <i class="fab fa-whatsapp me-1"></i>WhatsApp
                    </button>
                    <button class="btn btn-sm btn-outline-primary me-2" id="share-telegram-btn">
                        <i class="fab fa-telegram-plane me-1"></i>Telegram
                    </button>
                    <button class="btn btn-sm btn-outline-primary" id="share-email-btn">
                        <i class="fas fa-envelope me-1"></i>Email
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Next Steps -->
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h5 class="mb-0">Next Steps</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('venues', group_id=group_id) }}" class="btn btn-outline-primary">
                        <i class="fas fa-search me-2"></i>Find More Venues
                    </a>
                    <button class="btn btn-outline-success" id="finalize-btn">
                        <i class="fas fa-check-circle me-2"></i>Finalize Meetup
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Finalize Meetup Modal -->
<div class="modal fade" id="finalizeModal" tabindex="-1" aria-labelledby="finalizeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="finalizeModalLabel">Finalize Meetup</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Ready to finalize your meetup at <strong id="winner-venue-name">the selected venue</strong>?</p>
                <p>This will notify all group members about the final decision.</p>
                
                <form id="finalize-form">
                    <div class="mb-3">
                        <label for="meetup-date" class="form-label">Date</label>
                        <input type="date" class="form-control" id="meetup-date" required>
                    </div>
                    <div class="mb-3">
                        <label for="meetup-time" class="form-label">Time</label>
                        <input type="time" class="form-control" id="meetup-time" required>
                    </div>
                    <div class="mb-3">
                        <label for="meetup-notes" class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="meetup-notes" rows="3" 
                                  placeholder="Any additional details for your group..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirm-finalize-btn">
                    <i class="fas fa-check me-2"></i>Confirm
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast for notifications -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 5">
    <div id="notification-toast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="notification-message">
                Notification message here
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get group ID from URL
        const groupId = '{{ group_id }}';
        
        // Initialize results page
        if (typeof initResultsPage === 'function') {
            initResultsPage(groupId);
        } else {
            console.error('Results page initialization function not found');
        }
        
        // Load group info
        loadGroupInfo(groupId);
        
        // Set up copy URL button
        document.getElementById('copy-url-btn').addEventListener('click', function() {
            const shareUrl = document.getElementById('share-url');
            shareUrl.select();
            document.execCommand('copy');
            showNotification('URL copied to clipboard', 'success');
        });
        
        // Set up share buttons
        document.getElementById('share-whatsapp-btn').addEventListener('click', function() {
            const url = encodeURIComponent(document.getElementById('share-url').value);
            window.open(`https://wa.me/?text=Check%20out%20our%20meetup%20voting%20results:%20${url}`, '_blank');
        });
        
        document.getElementById('share-telegram-btn').addEventListener('click', function() {
            const url = encodeURIComponent(document.getElementById('share-url').value);
            window.open(`https://t.me/share/url?url=${url}&text=Check%20out%20our%20meetup%20voting%20results!`, '_blank');
        });
        
        document.getElementById('share-email-btn').addEventListener('click', function() {
            const url = document.getElementById('share-url').value;
            window.open(`mailto:?subject=Meetup%20Voting%20Results&body=Check%20out%20our%20meetup%20voting%20results:%20${url}`, '_blank');
        });
        
        // Set up finalize button
        document.getElementById('finalize-btn').addEventListener('click', function() {
            // Set default date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('meetup-date').valueAsDate = tomorrow;
            
            // Set default time to 7:00 PM
            document.getElementById('meetup-time').value = '19:00';
            
            // Show modal
            const finalizeModal = new bootstrap.Modal(document.getElementById('finalizeModal'));
            finalizeModal.show();
        });
        
        // Set up confirm finalize button
        document.getElementById('confirm-finalize-btn').addEventListener('click', function() {
            // This functionality will be implemented in a future update
            showNotification('Meetup finalization will be available in a future update', 'info');
            
            // Close modal
            const finalizeModal = bootstrap.Modal.getInstance(document.getElementById('finalizeModal'));
            finalizeModal.hide();
        });
    });
    
    // Load group info
    function loadGroupInfo(groupId) {
        if (!groupId) return;
        
        db.collection('groups').doc(groupId).get()
            .then(doc => {
                if (doc.exists) {
                    const group = doc.data();
                    
                    // Update group info
                    document.getElementById('group-name').textContent = group.name;
                    document.getElementById('group-description').textContent = group.description || 'No description';
                    
                    // Get member count
                    if (group.members) {
                        document.getElementById('member-count').textContent = Object.keys(group.members).length;
                    }
                    
                    // Get location count
                    db.collection('groups').doc(groupId).collection('locations').get()
                        .then(snapshot => {
                            document.getElementById('location-count').textContent = snapshot.size;
                        });
                }
            })
            .catch(error => {
                console.error('Error loading group info:', error);
            });
    }
</script>
{% endblock %}
