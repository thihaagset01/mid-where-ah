{% extends "mobile_base.html" %}

{% block title %}MidWhereAh - Event Map View{% endblock %}

{% block head %}
<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<!-- Event Map Manager CSS - contains all styling -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/event_map_manager.css') }}">

<!-- Google Maps API Preconnect -->
<link rel="preconnect" href="https://maps.googleapis.com">
<link rel="preconnect" href="https://maps.gstatic.com" crossorigin>

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#8B5DB8">
{% endblock %}

{% block content %}
<!-- Full-screen map -->
<div id="map"></div>

<!-- Loading Spinner -->
<div id="loading-spinner" class="loading-spinner">
    <div class="message-content">
        <i class="fas fa-spinner fa-spin"></i>
        <span>Loading event map...</span>
    </div>
</div>

<!-- Top Navigation Header - Enhanced for swipe functionality -->
<div class="event-nav-header" id="event-nav-header">
    <a href="{{ url_for('mobile.groups') }}" class="preload-link header-nav-button back-btn" aria-label="Go back to groups">
        <i class="fas fa-arrow-left"></i>
    </a>
    <div class="nav-title" id="nav-event-title">Event Map</div>
    <button class="header-nav-button filter-btn" aria-label="Open map options" id="options-toggle">
        <i class="fas fa-ellipsis-h"></i>
    </button>
</div>

<!-- Collapsible Top Drawer (swipes down from nav header) -->
<div class="locations-container" id="event-locations-container">
  <!-- Container Content - Now appears first/top -->
  <div class="container-content">
    <!-- Dynamic Member Location Containers -->
    <div id="member-locations">
      <!-- Member locations will be dynamically inserted here -->
    </div>

    <!-- Action Buttons Container -->
    <div class="event-actions-container" id="event-actions">
      <!-- Refresh Button -->
      <button id="refresh-locations-btn" class="action-circle-btn">
        <i class="fas fa-sync-alt"></i>
      </button>
      
      <!-- Find Meeting Point Button -->
      <button class="find-central-btn" id="find-meeting-point-btn">
        <i class="fas fa-location-arrow"></i>
        Find Meeting Point
      </button>
    </div>

    <!-- Venue Actions (appears after midpoint calculation) -->
    <div class="venue-actions-container" id="venue-actions" style="display: none;">
      <button id="find-venues-btn" class="action-circle-btn">
        <i class="fas fa-search"></i>
      </button>
      
      <button class="find-central-btn secondary" id="show-directions-btn">
        <i class="fas fa-route"></i>
        Get Directions
      </button>
    </div>
  </div>

  <!-- Handle Area - Now appears at bottom as visual indicator -->
  <div class="handle-area" id="container-handle">
    <h4 class="handle-title" id="handle-title">Event Locations</h4>
    <div class="container-handle"></div>
  </div>
</div>
{% endblock %}

{% block mobile_js %}
<!-- FIXED: Include required scripts for event map functionality -->
<script src="{{ url_for('static', filename='js/location/transport.js') }}"></script>
<script src="{{ url_for('static', filename='js/location/midpoint.js') }}"></script>
<script src="{{ url_for('static', filename='js/location/MapManager.js') }}"></script>
<script src="{{ url_for('static', filename='js/location/location-manager.js') }}"></script>
<script src="{{ url_for('static', filename='js/location/index.js') }}"></script>
<script src="{{ url_for('static', filename='js/VenueMapFeatures.js') }}"></script>
<script src="{{ url_for('static', filename='js/auth.js') }}"></script>
<script src="{{ url_for('static', filename='js/ui.js') }}"></script>
<script src="{{ url_for('static', filename='js/services/DistanceMatrixService.js') }}"></script>
<script src="{{ url_for('static', filename='js/services/MeetingPointOptimizer.js') }}"></script>

<!-- CRITICAL: Include AlgorithmVisualizer for event map visualization -->
<script src="{{ url_for('static', filename='js/services/AlgorithmVisualizer.js') }}"></script>

<script src="{{ url_for('static', filename='js/friends-api-adapter.js') }}"></script>
<script src="{{ url_for('static', filename='js/group-creation.js') }}"></script>
{% endblock %}

{% block scripts %}
<!-- Page-specific functionality (loads last) -->
<script src="{{ url_for('static', filename='js/event_map_manager.js') }}" defer></script>

<!-- Google Maps API with proper callback -->
{% if google_maps_api_key %}
<script async defer 
    src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places,geometry&callback=initMap&loading=async"
    onerror="handleMapError()">
</script>

<script>
function initMap() {
    // This will be called when Google Maps API loads
    console.log('üó∫Ô∏è Google Maps API loaded, initializing...');
    
    // Hide loading spinner immediately when Maps API loads
    const loadingSpinner = document.getElementById('loading-spinner');
    if (loadingSpinner) {
        loadingSpinner.style.display = 'none';
        console.log('‚úÖ Loading spinner hidden on map init');
    }
    
    // Create map
    const map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 1.3521, lng: 103.8198 }, // Singapore center
        zoom: 11,
        styles: [
            {
                featureType: "poi",
                elementType: "labels",
                stylers: [{ visibility: "off" }]
            }
        ]
    });

    // Notify EventMapManager that map is ready
    if (window.eventMapManager) {
        window.eventMapManager.onMapReady(map);
    }
    
    console.log('‚úÖ Map initialized successfully');
}

function handleMapError() {
    console.error('Failed to load Google Maps');
    
    // Hide loading spinner on error too
    const loadingSpinner = document.getElementById('loading-spinner');
    if (loadingSpinner) {
        loadingSpinner.style.display = 'none';
    }
    
    document.getElementById('map').innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f5f5f5;"><p>Failed to load map. Please refresh the page.</p></div>';
}

// Fallback: Hide spinner after 5 seconds if nothing else has hidden it
setTimeout(() => {
    const loadingSpinner = document.getElementById('loading-spinner');
    if (loadingSpinner && loadingSpinner.style.display !== 'none') {
        loadingSpinner.style.display = 'none';
        console.log('‚è∞ Loading spinner hidden by fallback timeout');
    }
}, 5000);
</script>
{% endif %}
{% endblock %}