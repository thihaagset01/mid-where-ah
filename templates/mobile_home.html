{% extends "mobile_base.html" %}

{% block title %}MidWhereAh - Find Your Midpoint{% endblock %}

{% block head %}
{{ super() }}
<!-- Page specific CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/autofill.css') }}">
{% endblock %}

{% block content %}
<!-- Full-screen map -->
<div id="map"></div>

<!-- Fixed Location Input Header -->
<div class="group-header-container">
  <div class="group-logo">
    <a href="javascript:void(0)" onclick="handleLogoClick()">
        <img src="static/images/logo.png" alt="Logo" />
    </a>
  </div>
  <div class="group-text">
    <span>MidWhereAh</span>
  </div>
</div>

<!-- Redesigned location inputs container -->
<div class="locations-container">
  <!-- Location 1 - SIMPLIFIED STRUCTURE -->
  <div class="location-container" data-person-id="1">
      <!-- Transport icon with more obvious icon -->
      <div class="transport-icon transit" 
           data-person="1" 
           data-current-mode="TRANSIT"
           data-tooltip="Public Transport">
          <i class="fas fa-subway"></i>
      </div>
      
      <input type="text" 
             id="location-1" 
             class="location-input" 
             placeholder="Address 1" 
             autocomplete="off">
      
      <button class="remove-person-btn"title="Remove Person">
          <i class="fas fa-times"></i>
      </button>
  </div>
    
  <!-- Location 2 - SIMPLIFIED STRUCTURE -->
  <div class="location-container" data-person-id="2">
      <!-- Transport icon with more obvious icon -->
      <div class="transport-icon transit" 
           data-person="2" 
           data-current-mode="TRANSIT"
           data-tooltip="Public Transport">
          <i class="fas fa-subway"></i>
      </div>
      
      <input type="text" 
             id="location-2" 
             class="location-input" 
             placeholder="Address 2" 
             autocomplete="off">
      
      <button class="remove-person-btn" title="Remove Person">
          <i class="fas fa-times"></i>
      </button>
  </div>
  
  <!-- Floating Add Person Button -->
  <button id="add-person-btn" class="add-person-circle">
      <i class="fas fa-plus"></i>
  </button>
</div>

<!-- Find Central Button -->
<div class="find-central-btn" id="find-central-btn">
  <i class="fas fa-location-arrow"></i>
</div>

<!-- Bottom Navigation is now in base template -->
{% endblock %}

{% block scripts %}
<!-- Load JavaScript (order matters) -->
<script src="{{ url_for('static', filename='js/maps.js') }}"></script>
<script src="{{ url_for('static', filename='js/mobile.js') }}"></script>

<!-- Stylized autofill script (must be loaded after mobile.js) -->
<script defer src="{{ url_for('static', filename='js/autofill.js') }}"></script>

<!-- Google Maps API -->
<script>
  // Handle logo click with authentication check
  function handleLogoClick() {
    if (firebase.auth().currentUser) {
      window.location.href = '/app';
    } else {
      window.location.href = '/login';
    }
  }

  window.initMap = initMap;
  
  document.addEventListener('DOMContentLoaded', function() {
    console.log('Map container:', document.getElementById('map'));
    console.log('Map container dimensions:', 
      document.getElementById('map').offsetWidth, 
      document.getElementById('map').offsetHeight);
      
    if (window.hybridLocationManager) {
      console.log('Initializing hybrid location manager...');
      window.hybridLocationManager.initialize();
    }
  });
  
  // Load Google Maps API with callback
  function loadGoogleMapsAPI() {
    // Create the script element
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places&callback=initMapWhenReady`;
    script.async = true;
    script.defer = true;
    document.head.appendChild(script);
  }
  
  // This function will be called when the API is loaded
  function initMapWhenReady() {
    console.log('Google Maps API loaded successfully');
    if (typeof initMap === 'function') {
      initMap();
    }
  }
  
  // Load the API
  loadGoogleMapsAPI();
  
  window.addEventListener('load', function() {
    setTimeout(function() {
      if (!window.midwhereahMap) {
        console.log('Map not initialized after timeout, trying again...');
        if (typeof initMap === 'function') {
          initMap();
        }
      }
    }, 1000);
  });
</script>
{% endblock %}