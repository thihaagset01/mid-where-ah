{% extends "base.html" %}

{% block title %}Vote on Venues{% endblock %}

{% block head %}
<!-- Google Maps API -->
<script src="https://maps.googleapis.com/maps/api/js?key={{ config.GOOGLE_MAPS_API_KEY }}&libraries=places" defer></script>
<script src="{{ url_for('static', filename='js/maps.js') }}" defer></script>
<!-- Swipe.js for touch interactions -->
<script src="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.js" defer></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.css">
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('group', group_id=group_id) }}" id="group-link">Group</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('venues', group_id=group_id) }}">Venues</a></li>
                <li class="breadcrumb-item active" aria-current="page">Vote</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-8">
        <h1>Vote on Venues</h1>
        <p class="text-muted">Swipe right to like, left to dislike</p>
    </div>
    <div class="col-md-4 text-md-end">
        <button class="btn btn-primary" id="view-results-btn">
            <i class="fas fa-chart-bar me-2"></i>View Results
        </button>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- Swipe Cards Container -->
        <div class="swipe-container mb-4">
            <div class="swiper" id="venues-swiper">
                <div class="swiper-wrapper" id="venues-cards">
                    <!-- Loading state -->
                    <div class="swiper-slide" id="loading-slide">
                        <div class="card shadow venue-card">
                            <div class="card-body text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-3">Loading venues...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- No venues state -->
                    <div class="swiper-slide d-none" id="no-venues-slide">
                        <div class="card shadow venue-card">
                            <div class="card-body text-center py-5">
                                <i class="fas fa-map-marker-alt fa-3x text-muted mb-3"></i>
                                <h4>No Venues Added</h4>
                                <p class="text-muted">Add venues from the recommendations page</p>
                                <a href="{{ url_for('venues', group_id=group_id) }}" class="btn btn-primary mt-3">
                                    Find Venues
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Venues will be dynamically added here -->
                </div>
            </div>
            
            <!-- Swipe Buttons -->
            <div class="swipe-buttons text-center mt-4">
                <button class="btn btn-lg btn-outline-danger rounded-circle me-4" id="dislike-btn">
                    <i class="fas fa-times fa-2x"></i>
                </button>
                <button class="btn btn-lg btn-outline-success rounded-circle" id="like-btn">
                    <i class="fas fa-heart fa-2x"></i>
                </button>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <!-- Chat Section -->
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h5 class="mb-0">Group Chat</h5>
            </div>
            <div class="card-body p-0">
                <div class="chat-container">
                    <div class="chat-messages" id="chat-messages">
                        <div class="text-center py-4" id="loading-chat">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mb-0 mt-2">Loading chat...</p>
                        </div>
                        
                        <!-- Messages will be dynamically added here -->
                    </div>
                    
                    <div class="chat-input p-3 border-top">
                        <form id="chat-form">
                            <div class="input-group">
                                <input type="text" class="form-control" id="chat-message" placeholder="Type a message..." required>
                                <button class="btn btn-primary" type="submit">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Results Modal -->
<div class="modal fade" id="resultsModal" tabindex="-1" aria-labelledby="resultsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resultsModalLabel">Voting Results</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center py-4" id="loading-results">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Calculating results...</p>
                </div>
                
                <div id="results-container" class="d-none">
                    <h4 class="mb-3">Top Venues</h4>
                    <div class="list-group" id="results-list">
                        <!-- Results will be dynamically added here -->
                    </div>
                    
                    <div class="mt-4 text-center" id="winner-container">
                        <h4>Winner</h4>
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h5 id="winner-name">Venue Name</h5>
                                <p class="text-muted mb-2" id="winner-address">Address</p>
                                <div class="d-flex justify-content-center mb-3">
                                    <span class="badge bg-success me-2" id="winner-rating">4.5</span>
                                    <span class="text-muted" id="winner-votes">10 votes</span>
                                </div>
                                <a href="#" class="btn btn-primary" id="winner-directions" target="_blank">
                                    <i class="fas fa-directions me-2"></i>Get Directions
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="share-results-btn">Share Results</button>
            </div>
        </div>
    </div>
</div>

<!-- Venue Card Template (hidden, used by JavaScript) -->
<template id="venue-card-template">
    <div class="swiper-slide">
        <div class="card shadow venue-card">
            <img src="" class="card-img-top venue-image" alt="Venue Image">
            <div class="card-body">
                <h4 class="venue-name">Venue Name</h4>
                <p class="venue-address text-muted mb-2">Address</p>
                <div class="d-flex align-items-center mb-3">
                    <span class="badge bg-success me-2 venue-rating">4.5</span>
                    <span class="text-muted venue-price me-3">$$</span>
                    <span class="text-muted venue-distance">1.2 km away</span>
                </div>
                <div class="venue-details mb-3">
                    <p class="venue-description">Description will appear here...</p>
                </div>
                <div class="d-flex justify-content-between">
                    <button class="btn btn-sm btn-outline-primary view-on-map-btn">
                        <i class="fas fa-map-marker-alt me-1"></i>View on Map
                    </button>
                    <a href="#" class="btn btn-sm btn-outline-secondary venue-website" target="_blank">
                        <i class="fas fa-external-link-alt me-1"></i>Website
                    </a>
                </div>
            </div>
        </div>
    </div>
</template>

<!-- Chat Message Template (hidden, used by JavaScript) -->
<template id="chat-message-template">
    <div class="chat-message">
        <div class="chat-message-header d-flex justify-content-between">
            <span class="message-sender fw-bold">User Name</span>
            <small class="message-time text-muted">12:34 PM</small>
        </div>
        <div class="message-content">
            Message content here
        </div>
    </div>
</template>

<!-- Result Item Template (hidden, used by JavaScript) -->
<template id="result-item-template">
    <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
        <div>
            <h6 class="mb-1 result-name">Venue Name</h6>
            <small class="text-muted result-address">Address</small>
        </div>
        <div class="d-flex align-items-center">
            <span class="badge bg-primary rounded-pill result-votes">8</span>
        </div>
    </div>
</template>

<!-- Toast for notifications -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 5">
    <div id="notification-toast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="notification-message">
                Notification message here
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<style>
    .chat-container {
        display: flex;
        flex-direction: column;
        height: 500px;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
    }
    
    .chat-message {
        margin-bottom: 1rem;
        padding: 0.75rem;
        border-radius: 0.5rem;
        background-color: #f8f9fa;
    }
    
    .chat-message.own-message {
        background-color: #e3f2fd;
    }
    
    .venue-card {
        height: 500px;
        overflow: hidden;
    }
    
    .venue-image {
        height: 200px;
        object-fit: cover;
    }
    
    .swipe-container {
        position: relative;
    }
    
    .feature-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 3rem;
        height: 3rem;
        font-size: 1.5rem;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Check authentication and redirect if not logged in
        // This will be implemented in app.js
        
        // Get group ID from URL
        const groupId = '{{ group_id }}';
        
        // Initialize swiper
        let swiper;
        
        // Load venues for voting
        // This will be implemented in app.js
        
        // Like button handler
        document.getElementById('like-btn').addEventListener('click', function() {
            // Like logic will be implemented in app.js
        });
        
        // Dislike button handler
        document.getElementById('dislike-btn').addEventListener('click', function() {
            // Dislike logic will be implemented in app.js
        });
        
        // Chat form submission
        document.getElementById('chat-form').addEventListener('submit', function(e) {
            e.preventDefault();
            // Chat logic will be implemented in app.js
        });
        
        // View results button
        document.getElementById('view-results-btn').addEventListener('click', function() {
            // Results logic will be implemented in app.js
            const resultsModal = new bootstrap.Modal(document.getElementById('resultsModal'));
            resultsModal.show();
        });
    });
</script>
{% endblock %}
